# Canglong Model V2 修订说明

## 1. 概述

本文档详细说明了Canglong Model V2相对于原始版本的主要修改、实现的机制、工作原理以及带来的好处。Model V2在传统Swin Transformer的基础上引入了基于风向的动态窗口交换机制，使模型能够根据气象数据中的风向信息动态调整窗口交换策略，从而提升模型对气象数据中物理规律的建模能力。

## 2. 主要修改内容

### 2.1 风向计算模块 (wind_direction.py)

#### 2.1.1 新增文件
- 创建了 `canglong/wind_direction.py` 文件，专门用于处理风向相关的计算

#### 2.1.2 核心功能实现
1. **风向计算函数** (`calculate_wind_direction`)
   - 根据u、v风场分量计算风向角度
   - 将结果转换为0-360度范围

2. **主导风向计算函数** (`calculate_dominant_wind_direction`)
   - 使用自适应平均池化处理不同分辨率的输入
   - 计算每个窗口区域的主导风向
   - 采用向量平均法确保风向计算的准确性

3. **风向ID转换函数** (`get_wind_direction_id`)
   - 将连续的风向角度转换为离散的方向ID (0-8)
   - 0表示不移位，1-8分别对应N、NE、E、SE、S、SW、W、NW方向

4. **风向处理器类** (`WindDirectionProcessor`)
   - 集成所有风向处理功能
   - 从输入数据中提取高空和表面风场信息
   - 计算并输出风向ID用于后续的窗口交换

### 2.2 风向感知注意力掩码生成器 (wind_aware_mask.py)

#### 2.2.1 新增文件
- 创建了 `canglong/wind_aware_mask.py` 文件

#### 2.2.2 核心功能实现
1. **预生成注意力掩码机制**
   - 预生成9份注意力掩码（1份不移位 + 8份按方向移位）
   - 实现了代码侵入性最低的设计原则
   - 确保掩码与特征解耦，不破坏已有CUDA kernel

2. **方向映射**
   - 0: 不移位
   - 1: N (北)
   - 2: NE (东北)
   - 3: E (东)
   - 4: SE (东南)
   - 5: S (南)
   - 6: SW (西南)
   - 7: W (西)
   - 8: NW (西北)

### 2.3 风向感知Transformer块 (wind_aware_block.py)

#### 2.3.1 新增文件
- 创建了 `canglong/wind_aware_block.py` 文件

#### 2.3.2 核心功能实现
1. **风向感知注意力机制** (`WindAwareEarthAttention3D`)
   - 继承自原有的EarthAttention3D
   - 支持根据风向ID动态选择注意力掩码

2. **风向感知Transformer块** (`WindAwareEarthSpecificBlock`)
   - 继承自原有的EarthSpecificBlock
   - 集成了风向感知的窗口交换机制
   - 保持与原有实现的兼容性

### 2.4 模型主文件 (model_v2.py)

#### 2.4.1 核心修改
1. **集成风向处理模块**
   - 在模型初始化时创建 `WindDirectionProcessor` 实例
   - 在前向传播过程中计算风向ID

2. **修改Transformer层**
   - 使用 `WindAwareEarthSpecificBlock` 替换原有的 `EarthSpecificBlock`
   - 在各层Transformer中传递风向ID信息

3. **保持架构一致性**
   - 保留了原有的编码器-解码器结构
   - 保持了原有的数据处理流程

## 3. 实现的机制

### 3.1 风向信息提取机制

#### 3.1.1 高空风场数据提取
- 从输入数据 `upper_air` (形状: B, 7, 5, 2, 721, 1440) 中提取第3、4层作为u、v风场分量
- 对所有压力层和时间步进行平均，得到综合的高空风场信息

#### 3.1.2 表面风场数据提取
- 从输入数据 `surface` (形状: B, 17, 2, 721, 1440) 中提取第5、6层作为10m高度的u、v风场分量
- 对时间步进行平均，得到稳定的表面风场信息

#### 3.1.3 风场数据融合
- 将高空和表面风场数据进行加权平均，得到综合的风场表示
- 确保模型能够同时考虑不同高度层的风场信息

### 3.2 窗口主导风向计算机制

#### 3.2.1 下采样处理
- 将原始721×1440分辨率的风向数据下采样到181×360分辨率
- 采用4×4的下采样策略，与模型的patch embedding保持一致

#### 3.2.2 窗口划分
- 在181×360的分辨率上进一步划分为45×90的窗口网格
- 每个窗口对应原图16×16的区域

#### 3.2.3 主导风向计算
- 对每个窗口内的风向数据进行向量平均
- 使用u、v分量的平均值计算主导风向，避免角度平均的奇异性问题

### 3.3 动态窗口交换机制

#### 3.3.1 风向ID映射
- 将连续的风向角度离散化为9个方向ID
- 每个窗口根据其主导风向获得对应的方向ID

#### 3.3.2 窗口交换策略
- 根据风向ID确定窗口交换的方向和距离
- 在Transformer的奇数层执行窗口交换，偶数层保持不变

#### 3.3.3 注意力掩码选择
- 根据风向ID从预生成的9份注意力掩码中选择合适的掩码
- 确保注意力机制能够关注到正确的相邻窗口

## 4. 工作原理

### 4.1 数据流处理过程

1. **输入数据预处理**
   - 接收表面数据(surface)和高空数据(upper_air)
   - 通过编码器提取特征表示

2. **风向信息计算**
   - 从输入数据中提取u、v风场分量
   - 计算风向角度并下采样到181×360分辨率
   - 计算每个窗口的主导风向并转换为方向ID

3. **特征处理流程**
   - 将提取的特征输入到Transformer层
   - 在每个Transformer块中传递风向ID信息
   - 根据风向ID动态调整窗口交换策略

4. **输出生成**
   - 通过解码器将特征转换回原始数据空间
   - 输出预测的表面和高空数据

### 4.2 动态窗口交换工作流程

1. **风向感知**
   - 在每个Transformer层开始时，获取当前层对应的风向ID

2. **窗口移位决策**
   - 根据风向ID确定窗口移位的方向和距离
   - 对于不移位的情况(ID=0)，保持原有处理方式

3. **窗口重排**
   - 按照确定的方向对窗口进行循环移位
   - 确保相邻窗口在移位后仍然保持空间连续性

4. **注意力计算**
   - 使用与风向ID对应的选择性注意力掩码
   - 确保注意力机制能够关注到正确的相邻窗口

5. **反向重排**
   - 在注意力计算完成后，将窗口恢复到原始位置
   - 确保输出特征与输入特征在空间上对齐

## 5. 实现的好处

### 5.1 物理一致性增强

#### 5.1.1 遵循大气动力学规律
- 传统的固定窗口交换机制忽略了气象数据中的物理规律
- 基于风向的动态窗口交换使模型能够更好地捕捉大气流动的物理特性
- 提升了模型对气象现象的建模准确性

#### 5.1.2 空间相关性建模
- 风向反映了不同区域之间的空间相关性
- 动态窗口交换能够根据实际的风向调整关注区域
- 提高了模型对长距离依赖关系的建模能力

### 5.2 模型性能提升

#### 5.2.1 预测精度改善
- 通过引入物理先验知识，提高了模型的预测准确性
- 在处理具有明显风向特征的气象现象时表现更优
- 减少了模型对训练数据的过度拟合

#### 5.2.2 泛化能力增强
- 动态窗口交换机制使模型能够适应不同的气象条件
- 在处理训练数据中未见过的风向模式时具有更好的鲁棒性
- 提高了模型在不同地理位置和季节的适用性

### 5.3 计算效率优化

#### 5.3.1 代码侵入性最低
- 通过模块化设计，将新功能作为独立模块集成
- 不需要大幅修改原有代码结构
- 保持了与原有实现的兼容性

#### 5.3.2 掩码与特征解耦
- 预生成的注意力掩码与特征计算分离
- 不破坏已有的CUDA kernel优化
- 保持了原有的计算效率

#### 5.3.3 灵活的扩展性
- 可以轻松添加更多的风向感知功能
- 支持不同的窗口大小和移位策略
- 便于后续的功能扩展和优化

### 5.4 可解释性提升

#### 5.4.1 物理意义明确
- 风向ID具有明确的物理含义
- 窗口交换策略与实际的大气流动模式相对应
- 提高了模型决策过程的可解释性

#### 5.4.2 可视化支持
- 风向ID可以直观地可视化为风向图
- 窗口交换过程可以可视化为流线图
- 便于分析模型的行为和性能

## 6. 技术细节和实现考虑

### 6.1 维度处理优化

#### 6.1.1 自适应池化
- 使用自适应平均池化处理不能整除的维度问题
- 避免了因维度不匹配导致的计算错误
- 提高了模型对不同输入尺寸的适应性

#### 6.1.2 向量平均法
- 采用u、v分量的向量平均计算主导风向
- 避免了角度平均可能产生的奇异性问题
- 提高了风向计算的准确性和稳定性

### 6.2 内存和计算优化

#### 6.2.1 预生成掩码
- 在模型初始化时预生成所有可能的注意力掩码
- 避免在前向传播过程中重复计算掩码
- 减少了运行时的计算开销

#### 6.2.2 参数共享
- 预生成的注意力掩码作为模型参数的一部分
- 在不同批次和样本之间共享相同的掩码
- 减少了内存占用和参数数量

### 6.3 鲁棒性增强

#### 6.3.1 边界处理
- 对于边界窗口采用循环边界条件
- 确保全球数据在经度方向上的连续性
- 避免了边界效应导致的计算错误

#### 6.3.2 异常值处理
- 对风向计算中的异常值进行平滑处理
- 避免单个异常值对整个窗口主导风向的影响
- 提高了模型对噪声的鲁棒性

## 7. 总结

Canglong Model V2通过引入基于风向的动态窗口交换机制，在保持原有模型架构和性能的基础上，显著增强了模型对气象数据中物理规律的建模能力。该实现具有以下特点：

1. **物理一致性**：通过引入风向信息，使模型更好地遵循大气动力学规律
2. **性能提升**：提高了模型的预测精度和泛化能力
3. **高效实现**：采用模块化设计，代码侵入性最低
4. **易于扩展**：支持灵活的功能扩展和优化
5. **可解释性强**：提高了模型决策过程的可解释性

该实现为气象预测模型的发展提供了新的思路和技术方案，具有重要的理论意义和实用价值。