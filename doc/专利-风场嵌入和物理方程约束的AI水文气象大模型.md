# 发明专利技术交底书

## 发明或实用新型名称
一种风场嵌入和物理方程约束的AI水文气象大模型

## 申请人信息
- **本专利申请人名称**：中国科学院地理科学与资源研究所
- **本专利发明人**：张永强，张选泽，王龙浩
- **技术交底书撰写人及技术联系人**：张永强
- **电话**：18123976023
- **E-MAIL**：zhangyq@igsnrr.ac.cn
- **组织机构代码**：121000004000115850

---

## 一、术语解释

| 术语 | 解释 |
|------|------|
| Swin-Transformer | 一种基于移位窗口的视觉Transformer架构，通过窗口划分和移位机制实现高效的自注意力计算 |
| PINN | Physics-Informed Neural Network，物理信息神经网络，将物理方程作为约束嵌入神经网络训练 |
| S2S预报 | Subseasonal-to-Seasonal，次季节到季节预报，预报时效为2-6周 |
| ERA5 | 欧洲中期天气预报中心(ECMWF)发布的第五代全球大气再分析数据集 |
| Patch Embedding | 将图像或场数据划分为小块(patch)并嵌入到高维特征空间的操作 |
| 静力平衡 | 大气中垂直方向上气压梯度力与重力相平衡的状态 |
| 位势高度 | 单位质量空气从海平面上升到某一高度所做的功，单位m²/s² |
| 潜热通量 | 由于水的相变(蒸发或凝结)而传递的热量 |
| 感热通量 | 由于温度差异通过热传导和对流传递的热量 |

---

## 二、本发明要解决的技术问题

针对现有技术的缺点，本发明要解决的技术问题包括：

1. **传统数值天气预报的计算效率问题**：传统数值天气预报模式需要求解复杂的偏微分方程组，计算成本高、时效性差，难以满足实时预报需求。

2. **现有AI天气模型缺乏物理约束**：现有的AI天气预测模型（如Pangu-Weather、FuXi、GraphCast等）主要基于纯数据驱动方法，预报结果可能违反基本物理定律（如质量守恒、能量守恒），导致长期预报出现非物理的漂移。

3. **标准Transformer未考虑大气流动方向性**：标准Swin-Transformer采用固定模式的窗口移位策略，未能利用大气中风场的物理方向性信息，限制了模型对大气动力学过程的学习能力。

4. **水文气象耦合预报的物理一致性问题**：现有模型难以同时保证水量平衡、能量平衡和动量守恒，导致预报的降水、蒸发、径流等水文变量与气象变量之间存在物理不一致性。

---

## 三、背景技术及现有技术方案

### 3.1 大背景：AI天气预报的兴起

随着深度学习技术的快速发展，人工智能天气预报近年来取得了突破性进展。2023年，华为发布的Pangu-Weather模型首次在多项预报指标上达到或超过欧洲中期天气预报中心(ECMWF)的业务模式。随后，Google的GraphCast、清华大学的FuXi等模型相继发布，AI天气预报进入快速发展期。

这些模型的共同特点是：
- 基于深度学习的端到端预报框架
- 使用大规模再分析数据(如ERA5)进行训练
- 采用Transformer或图神经网络作为骨干网络
- 预报速度比传统数值模式快数个数量级

### 3.2 小背景：现有技术的局限性

#### 3.2.1 Pangu-Weather模型
Pangu-Weather采用3D Swin-Transformer架构，将大气状态表示为三维张量（气压层×纬度×经度）。该模型使用标准的Swin-Transformer移位窗口策略，即在奇数层将窗口沿固定方向（如向下、向右）移位固定距离。

**缺点**：
- 固定移位模式未考虑大气实际的流动方向
- 缺乏物理约束，长期预报可能出现非物理漂移
- 未能有效利用风场信息指导特征传播

#### 3.2.2 FuXi模型
FuXi采用级联的U-Net架构，通过多个子模型分别预报不同时效。

**缺点**：
- 同样缺乏物理约束机制
- 级联结构导致误差累积
- 未建立预报变量之间的物理一致性

#### 3.2.3 GraphCast模型
GraphCast使用图神经网络，将地球表面离散化为网格图，通过消息传递机制学习大气动力学。

**缺点**：
- 图结构的构建未充分利用风场的方向性
- 缺乏显式的物理守恒约束
- 难以保证预报结果的物理合理性

### 3.3 现有技术的主要缺陷总结

1. **注意力机制与物理过程脱节**：标准Transformer的注意力机制是数据驱动的，未能将大气物理过程（如平流、对流）显式编码到模型结构中。

2. **缺乏物理守恒约束**：现有模型仅使用均方误差(MSE)作为损失函数，未将水量守恒、能量守恒、动量守恒等物理定律作为训练约束。

3. **预报变量间的物理不一致**：由于缺乏物理约束，模型预报的降水、蒸发、土壤水分等变量可能违反水量平衡；预报的辐射通量、热通量可能违反能量平衡。

---

## 四、本发明技术方案的详细阐述

本发明提出一种风场嵌入和物理方程约束的AI水文气象大模型，主要包括两大核心创新：（1）风向感知的Mask & Combine窗口移位策略；（2）多物理方程软约束损失函数。

### 4.1 模型整体架构

本发明模型的整体架构如图1所示，包括以下组成部分：

**输入层**：
- 高空层：10个变量 × 5个气压层(200, 300, 500, 700, 850 hPa)，维度为(B, 10, 5, 2, 721, 1440)
- 表面层：26个变量，维度为(B, 26, 2, 721, 1440)
- 地球常量层：64个静态变量（地形、土地覆盖等），维度为(64, 721, 1440)

**编码器**：
- 4D Patch Embedding：将高空层数据嵌入到高维特征空间
- 3D卷积编码器：对表面层数据进行编码
- 2D卷积：对地球常量进行编码

**Transformer骨干**：
- 采用U形结构的风向感知Swin-Transformer
- 包含下采样、多层Transformer块、上采样
- 每个Transformer块应用风向感知的双重移位策略

**解码器**：
- 3D卷积解码器：还原表面层变量
- 4D Patch Recovery：还原高空层变量

**输出**：
- 表面层预报：(B, 26, 1, 721, 1440)
- 高空层预报：(B, 10, 5, 1, 721, 1440)
- 支持6周滚动预报

```
图1 模型整体架构图

┌─────────────────────────────────────────────────────────────┐
│                        输入数据                              │
├──────────────┬──────────────┬───────────────────────────────┤
│  高空层       │   表面层      │      地球常量层               │
│ (10,5,2,     │  (26,2,      │       (64,                    │
│  721,1440)   │  721,1440)   │       721,1440)               │
└──────┬───────┴──────┬───────┴───────────┬───────────────────┘
       │              │                   │
       ▼              ▼                   ▼
┌──────────────┬──────────────┬───────────────────────────────┐
│ 4D Patch     │ 3D Conv      │      2D Conv                  │
│ Embedding    │ Encoder      │                               │
└──────┬───────┴──────┬───────┴───────────┬───────────────────┘
       │              │                   │
       └──────────────┼───────────────────┘
                      │
                      ▼
        ┌─────────────────────────────┐
        │     特征拼接 (Concat)        │
        │   (B, 96, 6, 181, 360)      │
        └──────────────┬──────────────┘
                       │
    ┌──────────────────┼──────────────────┐
    │                  │                  │
    ▼                  ▼                  ▼
┌────────┐      ┌────────────┐      ┌────────┐
│Layer 1 │      │  风向处理器 │      │        │
│(高分辨)│◄─────│ Wind Dir   │      │        │
└───┬────┘      │ Processor  │      │        │
    │           └────────────┘      │        │
    ▼                               │        │
┌────────┐                          │        │
│ Down   │                          │        │
│ Sample │                          │        │
└───┬────┘                          │        │
    │                               │  Skip  │
    ▼                               │Connect │
┌────────┐                          │        │
│Layer 2 │                          │        │
│(低分辨)│                          │        │
└───┬────┘                          │        │
    │                               │        │
    ▼                               │        │
┌────────┐                          │        │
│Layer 3 │                          │        │
│(低分辨)│                          │        │
└───┬────┘                          │        │
    │                               │        │
    ▼                               │        │
┌────────┐                          │        │
│  Up    │                          │        │
│ Sample │                          │        │
└───┬────┘                          │        │
    │                               │        │
    ▼                               ▼        │
┌────────┐                    ┌─────────┐   │
│Layer 4 │◄───────────────────│  Concat │◄──┘
│(高分辨)│                    └─────────┘
└───┬────┘
    │
    ├─────────────────────────┐
    │                         │
    ▼                         ▼
┌────────────┐          ┌────────────┐
│ 3D Conv    │          │ 4D Patch   │
│ Decoder    │          │ Recovery   │
└─────┬──────┘          └─────┬──────┘
      │                       │
      ▼                       ▼
┌────────────┐          ┌────────────┐
│  表面层     │          │   高空层    │
│  输出      │          │   输出      │
│(26,1,721,  │          │(10,5,1,721,│
│ 1440)      │          │ 1440)      │
└────────────┘          └────────────┘
```

### 4.2 创新点一：风向感知的Mask & Combine窗口移位策略

#### 4.2.1 技术动机

在大气中，天气系统的演变与风场密切相关。风将热量、水汽、动量从一个地区输送到另一个地区，这种平流过程是大气动力学的核心。标准Swin-Transformer采用固定的窗口移位策略，未能利用风场的物理方向性信息。

本发明提出的风向感知移位策略，将大气风场的方向性信息融入Transformer的窗口移位机制，使模型能够根据实际的大气流动方向调整特征的传播路径。

#### 4.2.2 风向计算与离散化

**步骤1：提取风场数据**

从输入数据中提取风场分量：
- 高空风场：从upper_air张量中提取u分量(索引3)和v分量(索引4)，覆盖5个气压层
- 地表风场：从surface张量中提取10m u分量(索引7)和10m v分量(索引8)

```python
# 高空u/v风场
upper_u = upper_air[:, 3, :, :, :, :]  # (B, 5, 2, 721, 1440)
upper_v = upper_air[:, 4, :, :, :, :]  # (B, 5, 2, 721, 1440)

# 地表10m u/v风场
surface_u = surface[:, 7, :, :, :]  # (B, 2, 721, 1440)
surface_v = surface[:, 8, :, :, :]  # (B, 2, 721, 1440)
```

**步骤2：计算综合风向**

将高空和地表风场综合，计算风向角度：

$$\theta = \arctan2(v, u) \times \frac{180}{\pi}$$

将角度转换到0-360度范围：

$$\theta_{normalized} = (\theta + 360) \mod 360$$

**步骤3：风向离散化为9个方向ID**

将连续的风向角度离散化为9个离散方向，如图2所示：

```
图2 风向ID离散化示意图

              N (1)
              ↑
              │
    NW (8)    │    NE (2)
        ╲     │     ╱
         ╲    │    ╱
          ╲   │   ╱
           ╲  │  ╱
    W (7) ────┼──── E (3)
           ╱  │  ╲
          ╱   │   ╲
         ╱    │    ╲
        ╱     │     ╲
    SW (6)    │    SE (4)
              │
              ↓
              S (5)

    ID=0: 无移位（风速很小或方向不确定）

    角度划分：
    ID=0: [340°, 360°) ∪ [0°, 20°)  - 无移位
    ID=1: [20°, 60°)   - N (北)
    ID=2: [60°, 100°)  - NE (东北)
    ID=3: [100°, 140°) - E (东)
    ID=4: [140°, 180°) - SE (东南)
    ID=5: [180°, 220°) - S (南)
    ID=6: [220°, 260°) - SW (西南)
    ID=7: [260°, 300°) - W (西)
    ID=8: [300°, 340°) - NW (西北)
```

#### 4.2.3 分区域独立风向计算

**步骤4：全球区域划分**

将全球划分为32个区域（4行×8列），每个区域独立计算主导风向。这种设计考虑到：
- 不同纬度带的环流系统差异（如信风带、西风带）
- 不同经度区域的天气系统差异
- 局地风场的空间变异性

```
图3 全球32区域划分示意图

    0°   45°  90°  135° 180° 225° 270° 315° 360°
    ├────┼────┼────┼────┼────┼────┼────┼────┤
90°N│ R1 │ R2 │ R3 │ R4 │ R5 │ R6 │ R7 │ R8 │
    ├────┼────┼────┼────┼────┼────┼────┼────┤
45°N│ R9 │R10 │R11 │R12 │R13 │R14 │R15 │R16 │
    ├────┼────┼────┼────┼────┼────┼────┼────┤
 0° │R17 │R18 │R19 │R20 │R21 │R22 │R23 │R24 │
    ├────┼────┼────┼────┼────┼────┼────┼────┤
45°S│R25 │R26 │R27 │R28 │R29 │R30 │R31 │R32 │
    └────┴────┴────┴────┴────┴────┴────┴────┘

每个区域内统计风向ID的众数，作为该区域的主导风向
```

**步骤5：计算各区域主导风向**

对每个区域，统计该区域内所有格点的风向ID，取众数作为该区域的主导风向：

$$\text{dominant\_direction}_{region} = \text{mode}(\{direction\_id_{i,j} | (i,j) \in region\})$$

#### 4.2.4 Mask & Combine窗口移位策略

**步骤6：预生成9种移位版本**

对于输入特征张量x，预先生成9种移位版本：

```python
# 风向ID到移位方向的映射
WIND_SHIFT_DIRECTIONS = {
    0: (0, 0),      # 无移位
    1: (-1, 0),     # N: 向北（纬度减小）
    2: (-1, 1),     # NE: 东北
    3: (0, 1),      # E: 向东（经度增大）
    4: (1, 1),      # SE: 东南
    5: (1, 0),      # S: 向南（纬度增大）
    6: (1, -1),     # SW: 西南
    7: (0, -1),     # W: 向西（经度减小）
    8: (-1, -1),    # NW: 西北
}

# 生成9种移位版本
for dir_id, (lat_shift, lon_shift) in WIND_SHIFT_DIRECTIONS.items():
    shifted_x = torch.roll(x, shifts=(lat_shift * scale, lon_shift * scale),
                          dims=(lat_dim, lon_dim))
    shifted_versions[dir_id] = shifted_x
```

**步骤7：创建区域掩码**

根据各区域的主导风向ID，创建9个掩码，每个掩码指示哪些区域应使用对应的移位版本：

```python
# 使用最近邻插值将区域风向放大到像素级
dirs_map = F.interpolate(regional_directions, size=(Lat, Lon), mode='nearest')

# 生成9个方向的掩码
for dir_id in range(9):
    masks[dir_id] = (dirs_map == dir_id).float()
```

**步骤8：掩码组合**

使用掩码从9种移位版本中选择并组合，得到最终的风向感知移位结果：

$$x_{shifted} = \sum_{id=0}^{8} mask_{id} \odot shifted\_version_{id}$$

```
图4 Mask & Combine窗口移位流程图

┌─────────────────────────────────────────────────────────┐
│                      输入特征 x                          │
│                   (B, Pl, Lat, Lon, C)                  │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│              生成9种移位版本                             │
│  ┌─────┐ ┌─────┐ ┌─────┐ ... ┌─────┐                   │
│  │ID=0 │ │ID=1 │ │ID=2 │     │ID=8 │                   │
│  │无移位│ │向北  │ │东北  │     │西北  │                   │
│  └─────┘ └─────┘ └─────┘     └─────┘                   │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│           根据区域主导风向创建掩码                        │
│  ┌──────────────────────────────────────────────────┐  │
│  │  R1:ID=2  R2:ID=3  R3:ID=3  R4:ID=2  ...        │  │
│  │  R9:ID=7  R10:ID=0 R11:ID=1 R12:ID=2 ...        │  │
│  │  ...                                            │  │
│  └──────────────────────────────────────────────────┘  │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                    掩码加权组合                          │
│     output = Σ (mask[id] × shifted_version[id])        │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                风向感知移位后的特征                       │
│                   (B, Pl, Lat, Lon, C)                  │
└─────────────────────────────────────────────────────────┘
```

#### 4.2.5 双重移位机制

本发明采用"Swin固定移位 + 风向额外移位"的双重移位策略：

1. **Swin固定移位**：保留标准Swin-Transformer的固定窗口移位，确保相邻窗口间的信息交换
2. **风向额外移位**：在Swin移位基础上，叠加基于物理风向的额外移位

```python
def forward_shift(self, x, wind_direction_id):
    # Step 1: Swin固定移位
    x = torch.roll(x, shifts=(-shift_pl, -shift_lat, -shift_lon), dims=(1, 2, 3))

    # Step 2: 风向额外移位（Mask & Combine）
    x = apply_regional_wind_shift(x, wind_direction_id)

    return x
```

### 4.3 创新点二：多物理方程软约束损失函数

#### 4.3.1 技术动机

深度学习模型的纯数据驱动特性可能导致预报结果违反基本物理定律。本发明将多个物理方程的残差作为软约束加入损失函数，引导模型学习物理一致的预报。

总损失函数为：

$$L_{total} = L_{MSE} + \lambda_{water} L_{water} + \lambda_{energy} L_{energy} + \lambda_{pressure} L_{pressure} + \lambda_{temp} L_{temp} + \lambda_{NS} L_{NS}$$

#### 4.3.2 水量平衡约束

**（a）陆地水量平衡**

在大流域尺度上，陆地水量平衡方程为：

$$\Delta S_{soil} = P_{land} - E_{land} - R$$

其中：
- $\Delta S_{soil}$：土壤储水变化量，由输出土壤水减去输入土壤水计算
- $P_{land}$：陆地降水，由大尺度降雨率和对流降雨率之和计算
- $E_{land}$：陆地蒸发，由潜热通量转换计算
- $R$：径流

计算时使用流域掩码(hydrobasin_exorheic_mask)限定在外流区：

```python
# 土壤水变化（需乘以土壤深度2.89m得到总水量）
delta_soil_water = (output_surface[:, 25, :, :] - input_surface[:, 25, :, :]) * 2.89

# 总降水（kg/m²/s → m）
large_scale_rain = output_surface[:, 4, :, :]  # 大尺度降雨率
convective_rain = output_surface[:, 5, :, :]   # 对流降雨率
p_total = (large_scale_rain + convective_rain) * delta_t / 1000  # 转换为m

# 蒸发（由潜热通量计算）
latent_heat_flux = output_surface[:, 13, :, :]  # J/m²
evaporation = latent_heat_flux / (2.5e6 * 1000)  # 转换为m

# 水量平衡残差（仅在流域掩码区域计算）
residual_water = (delta_soil_water - (p_total - evaporation)) * basin_mask
L_water = MSE(residual_water, 0)
```

**（b）海洋水量平衡**

$$\frac{dS_{ocean}}{dt} = P_{ocean} - E_{ocean} + R$$

使用陆海掩码(is_land)分离海洋区域。

**（c）大气水量平衡**

$$\frac{dS_{atmos}}{dt} = ET_{land} + E_{ocean} - P_{ocean} - P_{land}$$

**（d）全球水量守恒**

将上述三个方程相加，得到全球总水量守恒：

$$\frac{dS_{ocean}}{dt} + \frac{dS_{land}}{dt} + \frac{dS_{atmos}}{dt} = 0$$

```
图5 全球水量平衡约束示意图

                    ┌─────────────────┐
                    │     大气层       │
                    │   S_atmos       │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ▼ P_land        E_land+E_ocean ▲          ▼ P_ocean
        │                    │                    │
┌───────┴───────┐                         ┌───────┴───────┐
│    陆地        │         R              │     海洋       │
│   S_land      │ ──────────────────────► │    S_ocean    │
│               │                         │               │
│  土壤储水      │                         │  海洋储水      │
└───────────────┘                         └───────────────┘

守恒方程：dS_ocean/dt + dS_land/dt + dS_atmos/dt = 0
```

#### 4.3.3 能量平衡约束

**（a）陆地能量平衡**

陆地表面能量平衡方程（基于SEBAL算法）：

$$R_n = LE + H + G$$

其中：
- $R_n$：地表净辐射
- $LE$：潜热通量（蒸散发）
- $H$：感热通量
- $G$：土壤热通量

净辐射计算：

$$R_n = SW_{net} + LW_{net}$$

其中$SW_{net}$为平均表面净短波辐射通量(avg_snswrf, 索引15)，$LW_{net}$为平均表面净长波辐射通量(avg_snlwrf, 索引16)。

土壤热通量计算：

$$G = C_{soil} \cdot D \cdot \frac{\Delta T_{soil}}{\Delta t}$$

土壤体积热容：

$$C_{soil} = cs_{soil} + \theta \cdot c_w$$

其中：
- $cs_{soil}$：土壤固体体积热容（从静态数据加载）
- $\theta$：土壤体积含水量(swvl, 索引25)
- $c_w$：水的体积热容（$4.184 \times 10^6$ J/m³/K）
- $D$：土壤总深度（2.89m）

```python
# 净辐射（W/m²转换为J/m²需乘以时间）
sw_net = output_surface[:, 15, :, :] * delta_t  # 平均表面净短波
lw_net = output_surface[:, 16, :, :] * delta_t  # 平均表面净长波
R_n = sw_net + lw_net

# 潜热和感热通量
LE = output_surface[:, 13, :, :]  # 表面潜热通量 J/m²
H = output_surface[:, 14, :, :]   # 表面感热通量 J/m²

# 土壤热通量
theta = output_surface[:, 25, :, :]  # 土壤含水量
C_soil = cs_soil + theta * 4.184e6
delta_T_soil = output_surface[:, 24, :, :] - input_surface[:, 24, :, :]  # 土壤温度变化
G = C_soil * 2.89 * delta_T_soil

# 能量平衡残差（仅在陆地区域）
residual_energy = (R_n - LE - H - G) * land_mask
L_energy = MSE(residual_energy, 0)
```

**（b）海洋能量平衡**

$$Q_{net} = R_n - slhf - sshf$$

由于缺乏深层海洋温度数据，在短时间尺度上忽略海洋向下传热。

```
图6 陆地能量平衡约束示意图

         太阳短波辐射↓   大气长波辐射↓
              │              │
              ▼              ▼
        ┌─────────────────────────┐
        │      地表面              │
        │                         │
        │   R_n = SW_net + LW_net │
        └────────────┬────────────┘
                     │
        ┌────────────┼────────────┐
        │            │            │
        ▼            ▼            ▼
       LE           H            G
     潜热↑        感热↑       土壤热↓
    (蒸发)      (对流)      (传导)
        │            │            │
        ▼            ▼            ▼
     大气         大气         土壤

能量守恒：R_n = LE + H + G
```

#### 4.3.4 静力平衡约束

静力平衡描述大气中垂直方向上气压梯度力与重力的平衡：

$$\frac{\partial p}{\partial z} = -\rho g = -\frac{pg}{R_d T_v}$$

通过压高方程建立相邻气压层之间的约束：

$$\Phi_{p_2} - \Phi_{p_1} = R_d \cdot \frac{T_1 + T_2}{2} \cdot \ln\left(\frac{p_1}{p_2}\right)$$

对于5个气压层(200, 300, 500, 700, 850 hPa)，可以建立4对相邻层的约束。以850hPa和700hPa为例：

```python
# 位势高度（变量索引1=z）
phi_850 = output_upper_air[:, 1, 4, :, :]  # 850hPa层
phi_700 = output_upper_air[:, 1, 3, :, :]  # 700hPa层

# 温度（变量索引2=t）
temp_850 = output_upper_air[:, 2, 4, :, :]
temp_700 = output_upper_air[:, 2, 3, :, :]

# 模型预测的位势厚度
delta_phi_model = phi_700 - phi_850

# 物理公式计算的位势厚度
R_d = 287  # 干空气气体常数
temp_avg = (temp_700 + temp_850) / 2
delta_phi_physical = R_d * temp_avg * np.log(850 / 700)

# 静力平衡残差
residual_hydrostatic = delta_phi_model - delta_phi_physical
L_pressure = MSE(residual_hydrostatic, 0)
```

此外，还建立地表气压与海平面气压的约束：

$$p_{sfc} = p_{msl} \times \exp\left(-\frac{gz}{R_d T_v^{2m}}\right)$$

其中z为地形高度（从DEM静态数据获取）。

#### 4.3.5 气温局地变化方程约束

热力学能量方程描述大气温度的时间变化：

$$\frac{\partial T}{\partial t} = -V_h \cdot \nabla_h T - \left(\frac{R_d T}{c_p p} - \frac{\partial T}{\partial p}\right) \omega + \frac{1}{c_p}\frac{dQ}{dt}$$

各项含义：
- $\frac{\partial T}{\partial t}$：气温局地变化项
- $-V_h \cdot \nabla_h T$：水平平流项
- $\left(\frac{R_d T}{c_p p} - \frac{\partial T}{\partial p}\right) \omega$：绝热垂直运动项
- $\frac{1}{c_p}\frac{dQ}{dt}$：非绝热加热项

**气温局地变化项**：

$$\frac{\partial T}{\partial t} = \frac{T(t+1) - T(t)}{\Delta t}$$

**水平平流项**：

$$-V_h \cdot \nabla_h T = -u\frac{\partial T}{\partial x} - v\frac{\partial T}{\partial y}$$

其中梯度通过中央差分计算：

$$\frac{\partial T}{\partial x} = \frac{T(i+1,j) - T(i-1,j)}{2\Delta x}$$

**绝热垂直运动项**：

使用垂直速度$\omega$（Vertical velocity, 变量索引5）和温度垂直梯度计算。

**非绝热加热项**：

非绝热加热项$Q$包括辐射加热、潜热加热、感热加热三部分，计算较为复杂，本发明采用参数化方案近似计算（详见physical_constraint.md）。

```python
# 气温局地变化
dT_dt = (output_temp - input_temp) / delta_t

# 水平平流（使用中央差分计算梯度）
dT_dx = (T[:, :, :, :, 2:] - T[:, :, :, :, :-2]) / (2 * dx)
dT_dy = (T[:, :, :, 2:, :] - T[:, :, :, :-2, :]) / (2 * dy)
advection = -(u * dT_dx + v * dT_dy)

# 绝热垂直运动项
adiabatic = -(R_d * T / (c_p * p) - dT_dp) * omega

# 残差（忽略或参数化非绝热项）
residual_temp = dT_dt - advection - adiabatic
L_temp = MSE(residual_temp, 0)
```

#### 4.3.6 纳维-斯托克斯方程约束

大气运动的动量方程（简化的N-S方程）：

**u分量（纬向风）**：

$$\frac{\partial u}{\partial t} + u\frac{\partial u}{\partial x} + v\frac{\partial u}{\partial y} + w\frac{\partial u}{\partial z} = fv - \frac{1}{\rho}\frac{\partial p}{\partial x} + F_x$$

**v分量（经向风）**：

$$\frac{\partial v}{\partial t} + u\frac{\partial v}{\partial x} + v\frac{\partial v}{\partial y} + w\frac{\partial v}{\partial z} = -fu - \frac{1}{\rho}\frac{\partial p}{\partial y} + F_y$$

各项含义：
- $\frac{\partial u}{\partial t}$, $\frac{\partial v}{\partial t}$：风速时间变化率
- $(u\nabla)u$, $(v\nabla)v$：平流项
- $fv$, $-fu$：科氏力项，$f = 2\Omega\sin(\phi)$
- $-\frac{1}{\rho}\nabla p$：气压梯度力
- $F_x$, $F_y$：摩擦力项（使用湍流应力参数化）

```python
# 时间导数
du_dt = (output_u - input_u) / delta_t
dv_dt = (output_v - input_v) / delta_t

# 平流项（空间梯度使用中央差分）
advection_u = u * du_dx + v * du_dy + w * du_dz
advection_v = u * dv_dx + v * dv_dy + w * dv_dz

# 科氏力
f = 2 * 7.292e-5 * np.sin(np.radians(lat))  # 科氏参数
coriolis_u = f * v
coriolis_v = -f * u

# 气压梯度力
pgf_u = -(1/rho) * dp_dx
pgf_v = -(1/rho) * dp_dy

# 摩擦力（使用湍流应力）
friction_u = output_surface[:, 11, :, :]  # avg_iews
friction_v = output_surface[:, 12, :, :]  # avg_inss

# N-S方程残差
residual_u = du_dt + advection_u - coriolis_u - pgf_u - friction_u
residual_v = dv_dt + advection_v - coriolis_v - pgf_v - friction_v
L_NS = MSE(residual_u, 0) + MSE(residual_v, 0)
```

### 4.4 模型训练流程

```
图7 物理约束损失函数计算流程图

┌─────────────────────────────────────────────────────────────┐
│                    模型前向传播                              │
│         output_surface, output_upper_air = model(input)     │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      反标准化                                │
│            将标准化的输出还原为物理量值                        │
└───────────────────────────┬─────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│   MSE损失      │   │   物理约束     │   │   物理约束     │
│               │   │   计算        │   │   计算        │
│ L_surface +   │   │               │   │               │
│ L_upper_air   │   │ L_water      │   │ L_energy     │
└───────┬───────┘   │ L_pressure   │   │ L_temp       │
        │           │ L_NS         │   │               │
        │           └───────┬───────┘   └───────┬───────┘
        │                   │                   │
        └───────────────────┼───────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      总损失函数                              │
│  L_total = L_MSE + λ_water·L_water + λ_energy·L_energy     │
│          + λ_pressure·L_pressure + λ_temp·L_temp           │
│          + λ_NS·L_NS                                       │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      反向传播                                │
│                     参数更新                                 │
└─────────────────────────────────────────────────────────────┘
```

---

## 五、本发明的关键点和欲保护点

1. **风向感知的Mask & Combine窗口移位策略**：将大气风场的物理方向性信息融入Transformer的窗口移位机制，包括风向计算、9方向离散化、掩码生成和加权组合的完整流程。

2. **分区域独立风向计算方法**：将全球划分为32个区域(4×8)，每个区域独立计算主导风向，保持局地风场特征的同时避免全局平均导致的信息丢失。

3. **Swin固定移位 + 风向额外移位的双重移位机制**：在保留标准Swin-Transformer窗口移位的基础上，叠加基于物理风向的额外移位。

4. **多物理方程软约束损失函数设计**：将水量平衡、能量平衡、静力平衡、气温局地变化方程、纳维-斯托克斯方程的残差作为软约束加入损失函数。

5. **全球水量-能量-动量多守恒联合约束**：同时约束水圈、能量和动量守恒，确保预报结果的物理一致性。

6. **物理信息神经网络(PINN)在次季节-季节(S2S)预报中的应用**：将PINN框架应用于6周滚动预报，实现物理约束的长期预报。

---

## 六、与现有技术相比的有益效果

1. **风向感知移位提高预报准确性**：通过将大气风场的物理方向性信息融入Transformer结构，模型能够感知大气的实际流动方向，更准确地学习平流过程，提高风场和相关变量的预报准确性。

2. **物理约束确保预报的物理合理性**：通过多物理方程软约束，预报结果被引导遵循基本物理定律，避免出现非物理的预报结果，提高长期预报的稳定性。

3. **多守恒联合约束提高极端事件预测能力**：水量、能量、动量的联合守恒约束使模型能够更好地捕捉极端天气事件（如厄尔尼诺）中各圈层之间的物质和能量交换。

4. **在中国区域S2S预报中性能优越**：实验表明，在中国区域1-6周预报中，本发明模型的温度异常相关系数(ACC)优于欧洲中期天气预报中心(ECMWF)业务模式。

5. **计算效率高**：相比传统数值天气预报模式，本发明模型的预报速度快数个数量级，同时保持了物理约束的预报质量。

---

## 七、替代方案

### 7.1 风向感知移位的替代方案

除本发明采用的Mask & Combine方法外，风向感知移位还可通过以下方式实现：

1. **全局主导风向模式**：计算整个全球的主导风向，对所有区域应用相同的移位。该方法实现简单但忽略了风场的空间变异性。

2. **风向感知注意力掩码**：预先生成9份注意力掩码（对应9个风向），在注意力计算时根据风向选择相应掩码。该方法与特征解耦，但需要额外存储掩码。

3. **可学习的风向偏移**：将风向移位的幅度和方向作为可学习参数，通过端到端训练优化。该方法灵活但可能丢失物理解释性。

### 7.2 物理约束的替代方案

1. **硬约束方法**：将物理方程作为硬约束，通过投影或拉格朗日乘子法强制满足。该方法约束力强但可能影响模型表达能力。

2. **物理引导的网络架构**：设计专门的网络层显式计算物理量（如散度、旋度），而非仅通过损失函数约束。该方法物理性更强但增加网络复杂度。

3. **逐步增强约束**：在训练初期使用较小的物理约束权重，随着训练进行逐步增大，平衡数据拟合和物理约束。

---

## 八、附图清单

1. 图1：模型整体架构图
2. 图2：风向ID离散化示意图
3. 图3：全球32区域划分示意图
4. 图4：Mask & Combine窗口移位流程图
5. 图5：全球水量平衡约束示意图
6. 图6：陆地能量平衡约束示意图
7. 图7：物理约束损失函数计算流程图

---

## 九、其他有助于理解本技术的资料

### 9.1 模型输入变量说明

**表面层变量（26个）**：

| 索引 | 变量名 | 中文名称 | 单位 |
|------|--------|----------|------|
| 0 | avg_tnswrf | 平均顶部净短波辐射通量 | W/m² |
| 1 | avg_tnlwrf | 平均顶部净长波辐射通量 | W/m² |
| 2 | tciw | 总柱云冰水 | kg/m² |
| 3 | tcc | 总云覆盖率 | 0-1 |
| 4 | lsrr | 大尺度降雨率 | kg/m²/s |
| 5 | crr | 对流降雨率 | kg/m²/s |
| 6 | blh | 边界层高度 | m |
| 7 | u10 | 10米U风分量 | m/s |
| 8 | v10 | 10米V风分量 | m/s |
| 9 | d2m | 2米露点温度 | K |
| 10 | t2m | 2米温度 | K |
| 11 | avg_iews | 平均东向湍流表面应力 | N/m² |
| 12 | avg_inss | 平均北向湍流表面应力 | N/m² |
| 13 | slhf | 表面潜热通量 | J/m² |
| 14 | sshf | 表面感热通量 | J/m² |
| 15 | avg_snswrf | 平均表面净短波辐射通量 | W/m² |
| 16 | avg_snlwrf | 平均表面净长波辐射通量 | W/m² |
| 17 | ssr | 表面净太阳辐射 | J/m² |
| 18 | str | 表面净热辐射 | J/m² |
| 19 | sp | 表面气压 | Pa |
| 20 | msl | 平均海平面气压 | Pa |
| 21 | siconc | 海冰浓度 | 0-1 |
| 22 | sst | 海表温度 | K |
| 23 | ro | 径流 | m |
| 24 | stl | 土壤温度层(加权) | K |
| 25 | swvl | 体积土壤水层(加权) | m³/m³ |

**高空层变量（10个×5层）**：

| 索引 | 变量名 | 中文名称 | 单位 |
|------|--------|----------|------|
| 0 | o3 | 臭氧质量混合比 | kg/kg |
| 1 | z | 位势高度 | m²/s² |
| 2 | t | 温度 | K |
| 3 | u | U风分量 | m/s |
| 4 | v | V风分量 | m/s |
| 5 | w | 垂直速度 | Pa/s |
| 6 | q | 比湿 | kg/kg |
| 7 | cc | 云覆盖分数 | 0-1 |
| 8 | ciwc | 比云冰水含量 | kg/kg |
| 9 | clwc | 比云液水含量 | kg/kg |

**气压层（5层）**：200, 300, 500, 700, 850 hPa

### 9.2 物理常数

| 常数 | 符号 | 数值 | 单位 |
|------|------|------|------|
| 干空气气体常数 | $R_d$ | 287 | J/(kg·K) |
| 干空气定压比热 | $c_p$ | 1004 | J/(kg·K) |
| 水的蒸发潜热 | $L_v$ | 2.5×10⁶ | J/kg |
| 水的体积热容 | $c_w$ | 4.184×10⁶ | J/(m³·K) |
| 重力加速度 | $g$ | 9.8 | m/s² |
| 地球自转角速度 | $\Omega$ | 7.292×10⁻⁵ | rad/s |
| 土壤总深度 | $D$ | 2.89 | m |
| 预报时间步长 | $\Delta t$ | 604800 | s (1周) |

### 9.3 参考文献

1. Bi, K., et al. (2023). Pangu-Weather: A 3D High-Resolution Model for Fast and Accurate Global Weather Forecast. Nature.
2. Chen, L., et al. (2023). FuXi: A cascade machine learning forecasting system for 15-day global weather forecast. npj Climate and Atmospheric Science.
3. Lam, R., et al. (2023). GraphCast: Learning skillful medium-range global weather forecasting. Science.
4. Bastiaanssen, W.G.M., et al. (1998). A remote sensing surface energy balance algorithm for land (SEBAL). Journal of Hydrology.
5. Dai, Y., et al. (2019). A global high-resolution dataset of soil hydraulic and thermal properties for land surface modeling. J. Adv. Model. Earth System.

---

*技术交底书撰写完成*
