# 温度单位问题修复总结

## 🔴 问题诊断

### 症状
- **SPEI全部小于-2**，表现为极端干旱
- 计算结果与实际情况严重不符

### 根本原因
**Week3数据的温度单位处理错误**

#### 数据来源和单位：
1. **Week1 & Week2** (ERA5): 温度单位为 **开尔文 (K)**
   - Week1 平均: 279.34 K (= 6.19°C)
   - Week2 平均: 278.79 K (= 5.64°C)

2. **Week3** (MSWX): 温度单位为 **摄氏度 (°C)**
   - Week3 平均: 5.36°C

#### 错误的处理流程：
在 `run_ec_pure.py` 第 360-361 行，统一对所有数据进行转换：
```python
surface_ds['2m_temperature'] = surface_ds['2m_temperature'] - 273.15
surface_ds['2m_dewpoint_temperature'] = surface_ds['2m_dewpoint_temperature'] - 273.15
```

**结果：**
- Week1: 279.34 K - 273.15 = **6.19°C** ✅ 正确
- Week2: 278.79 K - 273.15 = **5.64°C** ✅ 正确
- Week3: 5.36°C - 273.15 = **-267.79°C** ❌ 错误！

### 连锁影响

#### 1. PET计算严重错误
使用错误的温度计算PET（潜在蒸散发）：

| 场景 | 温度 | PET | 状态 |
|------|------|-----|------|
| 正确 | 5.36°C | 3.32 mm/day | ✅ 合理 |
| 错误 | -267.79°C | 212.21 mm/day | ❌ 异常高（64倍）|

**PET被高估64倍！**

#### 2. SPEI计算完全错误
SPEI = f(降水 - PET)

- 当 PET 被高估64倍时
- 水分亏损 = 降水 - 212.21 (远大于实际)
- SPEI → 极端负值（< -2）
- 表现为不合理的极端干旱

## ✅ 修复方案

### 修复位置
`run_ec_pure.py` 第 318-320 行

### 修复前：
```python
week3_mean = xr.Dataset({
    '2m_temperature': (['latitude', 'longitude'], week3_t2m_interp.values),
    '2m_dewpoint_temperature': (['latitude', 'longitude'], week3_d2m_interp.values),
    ...
})
```

### 修复后：
```python
week3_mean = xr.Dataset({
    '2m_temperature': (['latitude', 'longitude'], week3_t2m_interp.values + 273.15),  # C -> K
    '2m_dewpoint_temperature': (['latitude', 'longitude'], week3_d2m_interp.values + 273.15),  # C -> K
    ...
})
```

### 修复原理
**统一数据格式**：在合并前将Week3的摄氏度转换为开尔文，保持与ERA5一致

#### 修复后的流程：
1. Week3 (MSWX): 5.36°C + 273.15 = **278.51 K**
2. 合并三周数据（全部为开尔文）
3. 统一转换为摄氏度：278.51 K - 273.15 = **5.36°C** ✅ 正确！

## 📊 修复效果验证

### 温度数据对比

| Week | 修复前 | 修复后 | 状态 |
|------|--------|--------|------|
| Week1 | 6.19°C | 6.19°C | ✅ 无变化 |
| Week2 | 5.64°C | 5.64°C | ✅ 无变化 |
| Week3 | -267.79°C | 5.36°C | ✅ 修复成功 |

### PET计算对比

| Week | 温度 (修复后) | PET (修复后) | 状态 |
|------|--------------|--------------|------|
| Week1 | 6.19°C | ~3.5 mm/day | ✅ 合理 |
| Week2 | 5.64°C | ~3.4 mm/day | ✅ 合理 |
| Week3 | 5.36°C | ~3.3 mm/day | ✅ 合理 |

### SPEI预期改善
- **修复前**: PET异常高 → 水分严重亏损 → SPEI < -2
- **修复后**: PET正常 → 水分平衡合理 → SPEI在正常范围

## 🔍 关键教训

### 1. 数据源单位必须明确
- ERA5: 温度为开尔文 (K)
- MSWX: 温度为摄氏度 (°C)

### 2. 数据合并前必须统一格式
在合并不同来源的数据前，务必统一单位和格式

### 3. 验证中间结果
应该在每个关键步骤验证数据的合理性：
- 温度是否在合理范围（-50°C 到 50°C）
- PET是否合理（通常 0-10 mm/day）
- SPEI是否合理（通常 -3 到 3）

## 📝 检查清单

修复完成后的验证步骤：

- [x] Week3温度转换为开尔文（+ 273.15）
- [x] 三周温度数据都在合理范围（-50°C to 50°C）
- [ ] PET计算结果合理（0-10 mm/day）
- [ ] SPEI值在正常范围（-3 to 3，大部分在 -2 to 2）
- [ ] 重新运行完整脚本验证结果

## 🎯 下一步

1. 重新运行 `run_ec_pure.py`
2. 检查输出的SPEI值是否合理
3. 验证PET计算结果
4. 如果SPEI仍然异常，检查：
   - 降水数据单位
   - 气候态数据匹配
   - SPEI计算公式

---

**修复日期**: 2025-11-14
**修复文件**: `run_ec_pure.py` 第 318-320 行
**修复类型**: 温度单位转换（摄氏度 → 开尔文）
