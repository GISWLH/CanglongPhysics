# CAS-Canglong Swin Transformer 模型参数分析报告

## 模型概述

CAS-Canglong 是一个基于 Swin Transformer 的 3D 天气预测模型，专门设计用于季节到次季节的全球海表温度预报。模型采用物理信息神经网络(PINN)方法，将地球科学知识融入深度学习架构。

## 模型架构配置

- **嵌入维度**: 96
- **注意力头数**: (8, 16, 16, 8)
- **窗口尺寸**: (2, 6, 12)
- **MLP 放大比例**: 4
- **深度配置**: Layer1(2) → Layer2(6) → Layer3(6) → Layer4(2)

## 参数统计总览

| 组件 | 参数量 | 占比 |
|------|--------|------|
| **Swin Transformer** | 31,256,064 | 85.0% |
| **Encoder/Decoder (VAE)** | 5,148,720 | 14.0% |
| **Recovery 层** | 233,499 | 0.6% |
| **Patch Embedding** | 113,952 | 0.3% |
| **常量处理层** | 9,696 | 0.0% |
| **总计** | **36,761,931** | **100%** |

## 详细组件分析

### 1. Swin Transformer 主干网络 (85.0%)

Swin Transformer 是模型的核心组件，采用分层结构：

#### Transformer 各层参数分布：
- **Layer1** (dim=96, depth=2): 3,403,008 参数 (10.9%)
- **Layer2** (dim=192, depth=6): 12,206,592 参数 (39.1%)
- **Layer3** (dim=192, depth=6): 12,206,592 参数 (39.1%)
- **Layer4** (dim=96, depth=2): 3,403,008 参数 (10.9%)
- **采样层** (上下采样): 36,864 参数 (0.1%)

#### 单个 EarthSpecificBlock 参数构成：
- **EarthAttention3D**: 1,626,912 参数 (95.6%)
  - 位置偏置表: 1,589,760 参数 (97.7%)
  - QKV 线性层: 27,936 参数 (1.7%)
  - 输出投影: 9,216 参数 (0.6%)
- **MLP**: 74,208 参数 (4.4%)
- **LayerNorm**: 384 参数 (0.0%)

#### 关键发现：
- **位置偏置表占主导**: EarthAttention3D 中 97.7% 的参数来自地球特定的位置偏置表
- **注意力机制重**: 每个 Block 中注意力机制占 95.6% 的参数

### 2. Encoder/Decoder (VAE) 组件 (14.0%)

采用 3D 卷积神经网络实现的变分自编码器：

- **Encoder**: 2,652,256 参数
  - 初始卷积: 16→64 通道
  - 残差块和下采样: 逐步增加特征维度
  - 输出维度: 96 (latent_dim)

- **Decoder**: 2,496,464 参数  
  - 输入维度: 192 (2×latent_dim)
  - 上采样和残差块: 逐步恢复空间分辨率
  - 输出: 16 通道特征图

### 3. Patch Embedding 层 (0.3%)

将不同维度的输入转换为统一的 patch token：

- **ImageToPatch2D**: 6,240 参数 (地表常量)
- **ImageToPatch3D**: 21,600 参数 (地表变量)
- **ImageToPatch4D**: 86,112 参数 (高空变量)

### 4. Recovery 层 (0.6%)

将 transformer 输出恢复为原始数据格式：

- **RecoveryImage2D**: 12,292 参数
- **RecoveryImage3D**: 49,168 参数
- **RecoveryImage4D**: 172,039 参数

## 内存占用分析

### 模型存储需求：
- **FP32**: 147.0 MB
- **FP16**: 73.5 MB
- **INT8**: 36.8 MB

### 推理内存估算 (batch_size=1)：
- **参数存储**: ~147 MB (FP32)
- **输入激活**: ~100 MB
- **推理总内存**: ~247 MB (不含注意力缓存)

⚠️ **注意**: 注意力矩阵可能占用大量内存(~4GB)，实际推理时需要注意内存优化。

## 与基线模型对比

| 模型 | 参数量 (M) | 相对大小 |
|------|------------|----------|
| ResNet-50 | 25.6 | 0.68× |
| Swin-Tiny | 29.0 | 0.77× |
| **CAS-Canglong** | **37.6** | **1.0×** |
| ResNet-101 | 44.5 | 1.18× |
| Swin-Small | 50.0 | 1.33× |
| ViT-Base | 86.6 | 2.30× |
| Swin-Base | 88.0 | 2.34× |
| FourCastNet | ~100.0 | 2.66× |
| PanguWeather | ~200.0 | 5.32× |

## 关键洞察

### 1. 参数分布特点
- **Transformer 占主导**: 85% 的参数集中在 Swin Transformer 主干网络
- **位置编码重**: 地球特定的位置偏置表占注意力机制参数的 97.7%
- **中间层最重**: Layer2 和 Layer3 (dim=192) 各占 39.1% 的参数

### 2. 模型规模定位
- **中等规模**: 37.6M 参数，介于小型模型(ResNet-50)和大型模型(ViT-Base)之间
- **天气模型对比**: 比 PanguWeather (~200M) 小约 5 倍，更适合实际部署

### 3. 设计特色
- **物理信息集成**: 通过地球特定的位置偏置融入地理先验
- **多尺度处理**: 采用 U-Net 风格的编码器-解码器结构
- **高效参数利用**: 相对较少的参数实现复杂的 3D 时空建模

## 优化建议

### 1. 参数效率优化
- **位置偏置压缩**: 考虑使用低秩分解或稀疏化减少位置偏置表大小
- **注意力优化**: 使用线性注意力或近似方法减少计算复杂度
- **模型剪枝**: 对 VAE 组件进行结构化剪枝

### 2. 内存优化
- **梯度检查点**: 在训练时使用检查点技术减少激活内存
- **混合精度**: 使用 FP16 推理减少内存占用 50%
- **序列化处理**: 分块处理长序列避免注意力矩阵过大

### 3. 计算优化
- **窗口大小调优**: 根据计算资源调整窗口尺寸
- **分层训练**: 先训练小模型再逐步扩展
- **知识蒸馏**: 用大模型指导小模型训练

## 结论

CAS-Canglong 模型以 37.6M 参数实现了复杂的 3D 天气预测任务，在参数效率和模型能力之间取得了良好平衡。模型的设计充分考虑了地球科学的物理约束，通过地球特定的位置编码和多维度数据处理实现了高精度的季节预报能力。

模型规模适中，便于实际部署和应用，同时保持了足够的表达能力来捕捉复杂的大气动力学过程。在未来的优化中，可以重点关注位置偏置表的压缩和注意力机制的效率提升。